# Discord増分収集システム 運用メモ

## 📋 概要

Discord情報収集で、**前回収集時刻以降の新しいメッセージのみを取得**する効率的なシステム。

## 🔧 実装済みファイル

### 核となるスクリプト
- `incremental_collector.js` - 増分収集メインロジック
- `run_incremental.sh` - 実行用シェルスクリプト  
- `last_collection.json` - 前回収集時刻とメタデータ保存

### 仕組み
1. **初回実行**: 2024年5月1日以降の全メッセージ収集
2. **2回目以降**: `last_collection.json`の時刻以降の新しいメッセージのみ
3. **進捗保存**: 収集完了後に最新時刻を記録
4. **重複回避**: 既存メッセージはスキップ

## 🚀 実行方法

### 事前準備
```bash
# Discord Bot Tokenの環境変数設定（必須）
export DISCORD_BOT_TOKEN="your_token_here"
```

### 増分収集実行
```bash
# 方法1: シェルスクリプト（推奨）
./run_incremental.sh

# 方法2: 直接実行
DISCORD_BOT_TOKEN="your_token" node incremental_collector.js

# 方法3: 月報生成込み
./run_incremental.sh
# → 収集後に月報生成確認あり
```

### 自動化設定
```bash
# crontab -e で設定
# 毎日午前2時に増分収集
0 2 * * * cd /Users/hashiguchimasaki/project/obsidian/100_discord_sync && ./run_incremental.sh

# 週1回月報生成
0 3 * * 1 cd /Users/hashiguchimasaki/project/obsidian/100_discord_sync && python3 monthly_report_analyzer.py
```

## 📊 出力・保存先

### 収集データ
- **保存先**: `00_Inbox/discord/`
- **ファイル名**: `{メンバー名}_{日付}_{タイプ}.json`
- **例**: `ログジ_2025-07-18_daily_report.json`

### 進捗ファイル
```json
{
  "timestamp": "2025-07-18T15:45:00.000Z",
  "totalMessages": 1250,
  "channels": {
    "日報": {"lastMessageId": "123456789"},
    "質問": {"lastMessageId": "987654321"}
  },
  "lastStats": {
    "newMessages": 25,
    "skippedMessages": 150,
    "collectionTime": "2025-07-18T15:45:00.000Z"
  }
}
```

## 🎯 実行トリガー

### gussanからの指示パターン
以下のような指示があった場合、増分収集を実行：

- 「実行して」「処理して」「取得して」
- 「情報収集して」「データ取得して」  
- 「最新の情報を」「新しいメッセージを」
- 「Discord連携」「月報生成」
- 「未取得分を取得」「差分収集」

### 実行前の確認
1. `last_collection.json`で前回収集時刻確認
2. 現在時刻との差分計算
3. 予想収集件数を表示
4. 実行可否確認

## ⚙️ システムの特徴

### 効率性
- **高速処理**: 新しいメッセージのみ
- **API制限回避**: 必要最小限のリクエスト
- **省リソース**: 重複処理なし

### 安全性
- **gussan除外**: 自動的にスキップ
- **メンバー正規化**: prog.ji→ログジ等の変換
- **エラー耐性**: 中断しても続きから再開

### 拡張性
- **Notion連携**: 収集後にNotionリンク処理
- **月報自動生成**: 収集データから月報作成
- **統計出力**: 処理件数、効率指標表示

## 🔄 運用フロー

### 日常運用
1. **指示受信**: 「情報収集して」等
2. **増分収集実行**: `./run_incremental.sh`
3. **結果確認**: 新規メッセージ件数表示
4. **月報生成**: 必要に応じて実行

### 週次運用
1. **月報生成**: 各メンバーの週次/月次レポート
2. **Notion連携**: 共有されたリンクの処理
3. **統計レビュー**: 収集効率、メンバー活動状況

### 月次運用
1. **データ整理**: 古いファイルのアーカイブ
2. **システム更新**: 新機能追加、改善
3. **バックアップ**: 重要データの保存

## 📝 メンテナンス

### 定期チェック項目
- [ ] `last_collection.json`の整合性
- [ ] Discord APIトークンの有効性
- [ ] 保存先ディスクの容量
- [ ] メンバー名マッピングの更新

### トラブル対応
- **収集失敗**: ログ確認、手動再実行
- **重複データ**: 重複排除スクリプト実行
- **API制限**: 遅延設定調整

---

## 🎯 重要な実行指示パターン

gussanが以下を言った場合は即座に増分収集実行：

✅ **実行系**: 「実行して」「処理して」「やって」
✅ **収集系**: 「取得して」「情報収集」「データ収集」
✅ **更新系**: 「最新の」「新しい」「未取得分」
✅ **システム系**: 「Discord連携」「月報生成」

**→ この指示を受けたら `./run_incremental.sh` を実行**

---
*最終更新: 2025-07-18*
*次回更新予定: システム改善時*