#!/usr/bin/env python3
"""
2ã¤ã®Notionã‚¢ã‚«ã‚¦ãƒ³ãƒˆçµ±åˆåŒæœŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ
"""
import os
import json
import requests
from datetime import datetime
import time
import re

# è¨­å®š
NOTION_ACCOUNTS = {
    "Main": {
        "token": "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",
        "output_dir": "/Users/hashiguchimasaki/project/obsidian/20_Literature/25_Notion/Main"
    },
    "Secondary": {
        "token": "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",
        "output_dir": "/Users/hashiguchimasaki/project/obsidian/20_Literature/25_Notion/Secondary"
    }
}

NOTION_VERSION = "2022-06-28"
BATCH_SIZE = 30  # APIåˆ¶é™ã‚’è€ƒæ…®ã—ã¦ã•ã‚‰ã«å°ã•ã

def get_headers(token):
    return {
        "Authorization": f"Bearer {token}",
        "Notion-Version": NOTION_VERSION,
        "Content-Type": "application/json"
    }

def sanitize_filename(filename):
    """ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚º"""
    filename = re.sub(r'[<>:"/\\|?*]', '_', filename)
    return filename.strip()[:100] or "Untitled"

def get_page_title(page):
    """ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—"""
    try:
        if 'properties' in page:
            for prop_name, prop_value in page['properties'].items():
                if prop_value['type'] == 'title' and prop_value.get('title'):
                    return prop_value['title'][0]['plain_text']
    except:
        pass
    return "Untitled"

def create_placeholder_batch(account_name, token, output_dir, batch_size=50):
    """ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒãƒƒãƒä½œæˆ"""
    print(f"\nğŸš€ Creating placeholders for {account_name} account")
    print("-" * 50)
    
    os.makedirs(output_dir, exist_ok=True)
    headers = get_headers(token)
    
    # å…¨ãƒšãƒ¼ã‚¸IDã‚’é«˜é€Ÿå–å¾—
    url = "https://api.notion.com/v1/search"
    payload = {
        "filter": {"property": "object", "value": "page"},
        "page_size": 100
    }
    
    all_pages = []
    has_more = True
    start_cursor = None
    
    while has_more:
        if start_cursor:
            payload["start_cursor"] = start_cursor
        
        response = requests.post(url, headers=headers, json=payload)
        if response.status_code == 200:
            data = response.json()
            batch_pages = data.get("results", [])
            all_pages.extend(batch_pages)
            has_more = data.get("has_more", False)
            start_cursor = data.get("next_cursor")
            
            if len(all_pages) % 100 == 0:
                print(f"  ğŸ“¥ Fetched {len(all_pages)} pages...")
        else:
            print(f"  âŒ Error: {response.status_code}")
            break
    
    print(f"  ğŸ“Š Total pages to process: {len(all_pages)}")
    
    # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ä½œæˆ
    created = 0
    skipped = 0
    
    for i, page in enumerate(all_pages):
        page_id = page['id']
        title = get_page_title(page)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«åä½œæˆ
        filename = f"{sanitize_filename(title)}.md"
        filepath = os.path.join(output_dir, filename)
        
        # æ—¢å­˜ãƒã‚§ãƒƒã‚¯
        if os.path.exists(filepath):
            skipped += 1
            continue
        
        # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ä½œæˆ
        metadata = f"""---
notion_id: {page_id}
account: {account_name}
title: {title}
url: {page.get('url', '')}
created_time: {page.get('created_time', '')}
last_edited_time: {page.get('last_edited_time', '')}
sync_status: placeholder
sync_time: {datetime.now().isoformat()}
---

# {title}

*ğŸ”„ This is a placeholder file from Notion {account_name} account.*

**Original URL**: {page.get('url', '')}

**Status**: Content will be synced in a future update.

**Page ID**: `{page_id}`

---

*Generated by Obsidian-Notion sync at {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*
"""
        
        try:
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(metadata)
            created += 1
            
            if (i + 1) % 50 == 0:
                print(f"  âœ… Progress: {i + 1}/{len(all_pages)} ({((i+1)/len(all_pages)*100):.1f}%)")
                
        except Exception as e:
            print(f"  âŒ Error creating {filename}: {str(e)}")
    
    # çµ±è¨ˆæƒ…å ±ä¿å­˜
    stats = {
        "account": account_name,
        "total_pages": len(all_pages),
        "placeholders_created": created,
        "skipped_existing": skipped,
        "sync_time": datetime.now().isoformat(),
        "status": "placeholders_created"
    }
    
    with open(os.path.join(output_dir, ".sync_stats.json"), 'w') as f:
        json.dump(stats, f, indent=2)
    
    return stats

def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    print("ğŸ”„ Dual Notion Account Sync - Placeholder Creation")
    print("=" * 60)
    
    all_stats = {}
    total_pages = 0
    total_created = 0
    
    for account_name, config in NOTION_ACCOUNTS.items():
        start_time = time.time()
        
        stats = create_placeholder_batch(
            account_name, 
            config["token"], 
            config["output_dir"]
        )
        
        end_time = time.time()
        elapsed = end_time - start_time
        
        all_stats[account_name] = stats
        total_pages += stats["total_pages"]
        total_created += stats["placeholders_created"]
        
        print(f"\nğŸ“Š {account_name} Account Summary:")
        print(f"   ğŸ“„ Total pages: {stats['total_pages']}")
        print(f"   âœ… Created: {stats['placeholders_created']}")
        print(f"   â­ï¸  Skipped: {stats['skipped_existing']}")
        print(f"   â±ï¸  Time: {elapsed:.1f} seconds")
        print(f"   ğŸ“‚ Output: {config['output_dir']}")
    
    # å…¨ä½“ã‚µãƒãƒªãƒ¼
    print("\n" + "=" * 60)
    print("ğŸ‰ DUAL SYNC SUMMARY")
    print("=" * 60)
    print(f"ğŸ“Š Total pages across accounts: {total_pages}")
    print(f"âœ… Total placeholders created: {total_created}")
    print(f"ğŸ“ Output structure:")
    for account_name, config in NOTION_ACCOUNTS.items():
        print(f"   ğŸ“‚ {account_name}: {config['output_dir']}")
    
    # å…¨ä½“çµ±è¨ˆä¿å­˜
    overall_stats = {
        "total_pages": total_pages,
        "total_created": total_created,
        "accounts": all_stats,
        "sync_time": datetime.now().isoformat()
    }
    
    base_dir = "/Users/hashiguchimasaki/project/obsidian/20_Literature/25_Notion"
    with open(os.path.join(base_dir, "dual_sync_summary.json"), 'w') as f:
        json.dump(overall_stats, f, indent=2)
    
    print(f"\nğŸ’¾ Summary saved to: {base_dir}/dual_sync_summary.json")
    
    # æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ææ¡ˆ
    print(f"\nğŸ¯ NEXT STEPS:")
    print("1. Review created placeholder files in Obsidian")
    print("2. Identify priority pages for full content sync") 
    print("3. Run content sync for specific pages/folders")
    print("4. Set up automated incremental sync")

if __name__ == "__main__":
    main()